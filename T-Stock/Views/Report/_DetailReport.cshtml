@model List<T_Stock.Models.Supplier>

@{
    ViewData["Title"] = "Detail_Report ";
}

@{
    ViewBag.Title = "Supplier Detail Report";
    var poCounts = ViewBag.POCounts as Dictionary<string, int> ?? new();
    var poAmounts = ViewBag.SupplierTotalAmount as Dictionary<string, decimal> ?? new();
    var lastPO = ViewBag.LastPODate as Dictionary<string, DateTime?> ?? new();
    var now = DateTime.Now;

    var start = ViewBag.StartDate as DateTime?;
    var end = ViewBag.EndDate as DateTime?;
    string periodText = "All Time";
    if (start.HasValue && end.HasValue)
    {
        periodText = $"{start.Value:yyyy-MM-dd} to {end.Value:yyyy-MM-dd}";
    }
    else if (start.HasValue)
    {
        periodText = $"From {start.Value:yyyy-MM-dd}";
    }
    else if (end.HasValue)
    {
        periodText = $"Until {end.Value:yyyy-MM-dd}";
    }
 
}

    <link rel="stylesheet" href="~/css/report.css" />
<div class="right-panel">
    <h2 class="report-title">Reports</h2>

    <div class="Dreport-header">
    <i class="ri-unsplash-fill"></i>
    <div class="Dreport-company">T-Stock</div>
    <div class="Dreport-address">
        Tunku Abdul Rahman University of Management and Technology (TARUMT) Cawangan Pulau Pinang
    </div>
    <div Dclass="Dreport-title">Detail Report</div>
    <div Dclass="report-generated">
        Generated on @now.ToString("dd MMMM yyyy HH:mm")
    </div>
</div>

<table class="Dreport-table">
    <thead>
        <tr>
            <th >Supplier ID</th>
            <th >Company Name</th>
            <th >Contact Person</th>
            <th >Phone / Email</th>
            <th class="text-center">PO Count</th>
            <th class="text-right">Total Amount</th>
            <th >Last Purchase</th>
        </tr>
    </thead>
    <tbody>
       
    @foreach (var s in Model)
        {
            var supplierId = s.SupplierID ?? "UNKNOWN";
            var count = poCounts.GetValueOrDefault(supplierId, 0);
            var amount = poAmounts.GetValueOrDefault(supplierId, 0m);
            var lastDate = lastPO.GetValueOrDefault(supplierId);

            var isInactive = !lastDate.HasValue || lastDate.Value < now.AddMonths(-1);

            int monthsAgo = lastDate.HasValue
            ? ((now.Year - lastDate.Value.Year) * 12 + now.Month - lastDate.Value.Month)
            : 999;

            if (monthsAgo < 0) monthsAgo += 12;

            <tr>
                <td class="font-bold">@s.SupplierID</td>
                <td>@s.Company</td>
                <td>@s.ContactPerson</td>
                <td>
                    @s.PhoneNumber<br />
                    <small class="text-muted">@s.Email</small>
                </td>
                <td class="text-center font-bold">@count</td>
                <td class="text-right font-bold">@amount.ToString("N2")</td>

                <td>
                    @if (!lastDate.HasValue)
                    {
                        <span class="text-red font-bold">Never</span>
                    }
                    else if (isInactive)
                    {
                        <span class="text-red font-bold">@lastDate.Value.ToString("yyyy-MM-dd")</span>
                
                        <br />
                        <small class="text-red">(@monthsAgo months inactive)</small>
                    }
                    else
                    {
                        <span class="text-green font-bold">@lastDate.Value.ToString("yyyy-MM-dd")</span>
                    }
                </td>

                
            
                 </tr>
        }
    </tbody>
</table>

<div class="Dreport-footer">
    Generated by System • Page 1 of 1 • @now
</div>