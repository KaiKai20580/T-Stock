@model T_Stock.Models.StockTransactionListVM

@{
    ViewData["Title"] = "Stock Management";

    bool isAjax = false;
    if (Context?.Request?.Headers != null &&
        Context.Request.Headers["X-Requested-With"] == "XMLHttpRequest")
    {
        isAjax = true;
    }

    Layout = isAjax ? null : "_Layout";
}

<div class="STOCK">
    @* --- Success Notification for New Transaction --- *@
    @if (ViewBag.NewTxId != null)
    {
        <div class="alert alert-success" style="background-color: #d4edda; color: #155724; padding: 10px; margin-bottom: 20px; border-radius: 5px; border: 1px solid #c3e6cb;">
            <strong>Success!</strong> Transaction @ViewBag.NewTxId has been created successfully.
        </div>
    }

    <div class="stock-heading">
        <h3>Stock Management</h3>

        <div class="search-container">
            <input type="text" id="searchBox" placeholder="Search ID, User, or Reason..." />
            <i class="ri-search-line"></i>
        </div>
    </div>

    @* --- Management Section --- *@
    <div class="stockManage">

        <div class="filter-container">
            <div class="filter-group">
                <label>Filter Type</label>
                <select id="typeFilter" class="filters">
                    <option value="all">All Types</option>
                    <option value="IN">Stock In</option>
                    <option value="OUT">Stock Out</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Sort By</label>
                <select id="sortBy" class="filters">
                    <option value="date">Date</option>
                    <option value="txid">Transaction ID</option>
                    <option value="userid">User ID</option>
                    <option value="type">Type</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Order</label>
                <select id="sortOrder" class="filters">
                    <option value="desc">Descending</option>
                    <option value="asc">Ascending</option>
                </select>
            </div>

            <a class="btn-create-stock" href="@Url.Action("CreateTransaction", "Stock")">
                Create Transaction
            </a>

        </div>
    </div>

    @* --- Table Container --- *@
    <div id="stockList">
        <partial name="_StockTable" model="Model" />
    </div>

</div>

<style>
    /* =========================================
               DEFAULT STYLES (Your provided styles)
           ========================================= */

    .stockManage {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 20px;
        justify-content: space-between;
        align-items: flex-end;
    }

    .filter-container {
        display: flex;
        gap: 15px;
        align-items: flex-end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

        .filter-group label {
            font-size: 14px;
            color: #666;
            margin-bottom: 4px;
            font-weight: 600;
        }

    .filters {
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #ccc;
        background-color: white;
        min-width: 140px;
        cursor: pointer;
    }

        .filters:focus {
            border-color: #007bff;
            outline: none;
        }

    .btn-create-stock {
        padding: 9px 25px;
        background-color: #28a745;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: bold;
        border: none;
        transition: background-color 0.2s;
        display: inline-block;
        white-space: nowrap;
    }

        .btn-create-stock:hover {
            background-color: #218838;
            color: white;
        }

    /* Table Styles Override to ensure layout consistency */
    #stockList table {
        width: 100%;
        border-collapse: collapse;
    }

    #stockList th {
        background: #f1f1f1;
        font-weight: bold;
        padding: 12px;
    }

    /* =========================================
               DARK MODE
           ========================================= */

    body.dark-mode .STOCK {
        color: #e0e0e0;
    }

        body.dark-mode .STOCK h3 {
            color: #ffffff;
        }

    body.dark-mode .search-container input {
        background-color: #2d2d2d;
        color: #ffffff;
        border: 1px solid #444;
    }

    body.dark-mode .filters {
        background-color: #2d2d2d;
        color: #ffffff;
        border: 1px solid #444;
    }

    body.dark-mode .filter-group label {
        color: #bbb;
    }

    body.dark-mode #stockList th {
        background-color: #2c3e50;
        color: #ffffff;
        border-bottom: 2px solid #444;
    }

    body.dark-mode #stockList td {
        background-color: #1e1e1e;
        color: #cccccc;
        border-bottom: 1px solid #333;
    }

    body.dark-mode .stock-row:hover td {
        background-color: #333333;
        color: #ffffff;
    }

    /* Ensure the detail row matches dark mode */
    body.dark-mode .tx-detail-row {
        background-color: #252525 !important;
    }

    body.dark-mode .tx-detail-container {
        border-color: #444;
        color: #ddd;
    }
</style>

<script>
    (function () {
        const typeFilter = document.getElementById('typeFilter');
        const sortBy = document.getElementById('sortBy');
        const sortOrder = document.getElementById('sortOrder');
        const searchBox = document.getElementById('searchBox');

        // Target the table specifically
        const table = document.getElementById('stockTable');

        function updateTable() {
            // Re-select tbody in case partial reloaded (though in this version it's static)
            const tableBody = table ? table.querySelector('tbody') : null;
            if (!tableBody) return;

            const rows = Array.from(tableBody.querySelectorAll('tr.stock-row'));

            let rowData = rows.map(row => {
                const cells = row.querySelectorAll('td');
                const detailRow = row.nextElementSibling;

                // --- MAP COLUMNS CORRECTLY TO _StockTable.cshtml ---
                // 0: Tx ID | 1: User ID | 2: Date | 3: Reason | 4: Type | 5: Actions

                const txid = cells[0] ? cells[0].innerText.trim() : "";
                const userid = cells[1] ? cells[1].innerText.trim() : "";

                // For Date: Replace newline with space to ensure "2023-01-01\n12:00" parses correctly
                let dateRaw = cells[2] ? cells[2].innerText.trim() : "";
                const dateStr = dateRaw.replace(/(\r\n|\n|\r)/gm, " ");

                const reason = cells[3] ? cells[3].innerText.trim() : "";
                const typeText = cells[4] ? cells[4].innerText.trim().toUpperCase() : "";

                // Build search string: ID + User + Reason
                const searchString = `${txid} ${userid} ${reason}`.toLowerCase();

                return {
                    element: row,
                    detailElement: detailRow,
                    txid: txid,
                    userid: userid,
                    dateStr: dateStr,
                    type: typeText,
                    searchText: searchString
                };
            });

            // 1. FILTERING
            const filterTypeValue = typeFilter.value;
            const searchValue = searchBox.value.toLowerCase().trim();

            rowData.forEach(item => {
                let isVisible = true;

                // Check Type
                if (filterTypeValue !== 'all') {
                    if (item.type !== filterTypeValue) {
                        isVisible = false;
                    }
                }

                // Check Search
                if (searchValue && !item.searchText.includes(searchValue)) {
                    isVisible = false;
                }

                // Apply Visibility
                item.element.style.display = isVisible ? '' : 'none';

                // Always hide detail row when filtering/sorting happens
                if (item.detailElement && item.detailElement.classList.contains('tx-detail-row')) {
                    item.detailElement.style.display = 'none';
                    // Reset button text
                    const btn = item.element.querySelector('.btn-view-tx');
                    if (btn) btn.textContent = 'View';
                }
            });

            // 2. SORTING
            const sortKey = sortBy.value;
            const order = sortOrder.value;

            rowData.sort((a, b) => {
                let valA, valB;

                if (sortKey === 'date') {
                    valA = new Date(a.dateStr).getTime();
                    valB = new Date(b.dateStr).getTime();
                } else if (sortKey === 'txid') {
                    valA = a.txid;
                    valB = b.txid;
                } else if (sortKey === 'userid') {
                    valA = a.userid;
                    valB = b.userid;
                } else if (sortKey === 'type') {
                    valA = a.type;
                    valB = b.type;
                }

                if (valA < valB) return order === 'asc' ? -1 : 1;
                if (valA > valB) return order === 'asc' ? 1 : -1;
                return 0;
            });

            // 3. RE-APPEND SORTED ROWS
            rowData.forEach(item => {
                tableBody.appendChild(item.element);
                if (item.detailElement) {
                    tableBody.appendChild(item.detailElement);
                }
            });
        }

        // Attach Events
        if (typeFilter) typeFilter.addEventListener('change', updateTable);
        if (sortBy) sortBy.addEventListener('change', updateTable);
        if (sortOrder) sortOrder.addEventListener('change', updateTable);
        if (searchBox) searchBox.addEventListener('keyup', updateTable);

        // Initial trigger to ensure correct order
        // updateTable();
    })();
</script>