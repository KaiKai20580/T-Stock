@model T_Stock.Models.StockTransactionListVM
<title>@ViewData["Title"]</title>
@{
    bool isAjax = false;
    if (Context?.Request?.Headers != null &&
        Context.Request.Headers["X-Requested-With"] == "XMLHttpRequest")
    {
        isAjax = true;
    }

    ViewData["Title"] = "Stock Management";
    Layout = isAjax ? null : "_Layout";
}

<div class="STOCK">
    <div class="stock-heading">
        <h3>Stock Management</h3>

        <div class="search-container">
            <input type="text" id="searchBox" placeholder="Search..." />
            <i class="ri-search-line"></i>
        </div>
    </div>

    @*Management Section*@
    <div class="stockManage">

        <div class="filter-container">
            <div class="filter-group">
                <label>Filter Type</label>
                <select id="typeFilter" class="filters">
                    <option value="all">All Types</option>
                    <option value="IN">Stock In</option>
                    <option value="OUT">Stock Out</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Sort By</label>
                <select id="sortBy" class="filters">
                    <option value="date">Date</option>
                    <option value="txid">Transaction ID</option>
                    <option value="userid">User ID</option>
                    <option value="type">Type</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Order</label>
                <select id="sortOrder" class="filters">
                    <option value="desc">Descending (Z-A)</option>
                    <option value="asc">Ascending (A-Z)</option>
                </select>
            </div>

            <a class="btn-create-stock ajax-nav" data-ajax="page" href="@Url.Action("CreateTransaction", "Stock")">
                Create
            </a>

        </div>
    </div>  

    <div id="stockList">
        <partial name="_StockTable" model="Model" />
    </div>

</div>

<style>
    /* =========================================
           DEFAULT LIGHT MODE STYLES
           ========================================= */

    /* Management Container */
    .stockManage {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 20px;
        justify-content: space-between;
        align-items: flex-end;
    }

    /* Filter Container */
    .filter-container {
        display: flex;
        gap: 15px;
        align-items: flex-end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

        .filter-group label {
            font-size: 14px;
            color: #666;
            margin-bottom: 4px;
            font-weight: 600;
        }

    .filters {
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #ccc;
        background-color: white;
        min-width: 140px;
        cursor: pointer;
    }

        .filters:focus {
            border-color: #007bff;
            outline: none;
        }

    /* Green Create Button Styling */
    .btn-create-stock {
        padding: 9px 25px;
        background-color: #28a745;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: bold;
        border: none;
        transition: background-color 0.2s;
        display: inline-block;
        white-space: nowrap;
    }

        .btn-create-stock:hover {
            background-color: #218838;
            color: white;
        }

    /* --- UPDATED TABLE STYLING --- */
    #stockList table {
        width: 100%;
        border-collapse: collapse;
        font-family: sans-serif;
        table-layout: auto;
    }

    #stockList th, #stockList td {
        padding: 12px;
        border-bottom: 1px solid #ddd;
        text-align: left;
    }

        /* 1. MAKE TRANSACTION ID (Column 1) EXPAND */
        #stockList th:nth-child(1),
        #stockList td:nth-child(1) {
            width: 100%;
            min-width: 200px;
        }

        /* 2. MAKE OTHER COLUMNS SHRINK TO FIT CONTENT */
        #stockList th:not(:nth-child(1)),
        #stockList td:not(:nth-child(1)) {
            width: 1%;
            white-space: nowrap;
        }

    #stockList th {
        background: #f1f1f1;
        font-weight: bold;
    }

    .stock-row:hover {
        background: #f9f9f9;
    }

    /* Hide detail rows initially */
    .tx-detail-row {
        display: none;
        background: #f8f9fa;
    }

    /* =========================================
           DARK MODE - STOCK SPECIFIC STYLES
           ========================================= */

    /* 1. Main Container Background */
    body.dark-mode .STOCK {
        color: #e0e0e0;
        border-radius: 15px;
        padding: 20px; /* Optional: adds padding inside the dark box */
    }

        /* 2. Heading */
        body.dark-mode .STOCK h3 {
            color: #ffffff;
        }

    /* 3. Search Bar */
    body.dark-mode .search-container input {
        background-color: #2d2d2d;
        color: #ffffff;
        border: 1px solid #444;
        box-shadow: none;
    }

    body.dark-mode .search-container i {
        color: #bbb;
    }

    /* 4. Filters & Labels */
    body.dark-mode .filter-group label {
        color: #bbb;
    }

    body.dark-mode .filters {
        background-color: #2d2d2d;
        color: #ffffff;
        border: 1px solid #444;
    }

        body.dark-mode .filters:focus {
            border-color: #007bff; /* Keep blue focus or change to lighter grey */
        }

    /* 5. Stock List Table */
    /* Table Header */
    body.dark-mode #stockList th {
        background-color: #2c3e50; /* Professional Dark Blue-Grey */
        color: #ffffff;
        border-bottom: 2px solid #444;
    }

    /* Table Cells */
    body.dark-mode #stockList td {
        background-color: #1e1e1e;
        color: #cccccc;
        border-bottom: 1px solid #333;
    }

    /* Table Row Hover Effect */
    body.dark-mode .stock-row:hover td {
        background-color: #333333;
        color: #ffffff;
    }

    /* 6. Transaction Details (The Hidden Row) */
    body.dark-mode .tx-detail-row {
        background-color: #252525; /* Slightly lighter than main bg to show depth */
    }

    body.dark-mode .tx-detail-container {
        border: 1px solid #444;
        color: #ddd;
    }

    /* 7. Buttons */
    /* Create Button (Keep Green, just ensure text is white) */
    body.dark-mode .btn-create-stock {
        color: white;
        /* Optional: darken slightly for better contrast if needed */
        /* background-color: #1e7e34; */
    }

    /* View Button inside table */
    body.dark-mode .btn-view-tx {
        background-color: #138496; /* Darker Cyan */
        color: #fff;
        border: 1px solid #0f6674;
    }

        body.dark-mode .btn-view-tx:hover {
            background-color: #117a8b;
        }

    /* Small timestamp text */
    body.dark-mode #stockList td div[style*="color: #555"] {
        color: #888 !important; /* Make the small time text lighter in dark mode */
    }
</style>

<script>
    (function () {
        const typeFilter = document.getElementById('typeFilter');
        const sortBy = document.getElementById('sortBy');
        const sortOrder = document.getElementById('sortOrder');
        const searchBox = document.getElementById('searchBox');
        const tableBody = document.querySelector('#stockTable tbody');

        function updateTable() {
            if (!tableBody) return;

            const rows = Array.from(tableBody.querySelectorAll('tr.stock-row'));

            let rowData = rows.map(row => {
                const cells = row.querySelectorAll('td');
                const detailRow = row.nextElementSibling;

                // Extract specific columns
                const txid = cells[0].innerText.trim();
                const userid = cells[1].innerText.trim();
                const dateStr = cells[2].innerText.trim();
                const typeText = cells[4].innerText.trim().toUpperCase();

                // Build search text ONLY from Transaction ID and User ID
                const searchString = (txid + " " + userid).toLowerCase();

                return {
                    element: row,
                    detailElement: detailRow,
                    txid: txid,
                    userid: userid,
                    dateStr: dateStr,
                    type: typeText,
                    searchText: searchString // Search target
                };
            });

            // FILTERING
            const filterTypeValue = typeFilter.value;
            const searchValue = searchBox.value.toLowerCase().trim();

            rowData.forEach(item => {
                let isVisible = true;

                // 1. Check Type Filter
                if (filterTypeValue !== 'all') {
                    if (!item.type.includes(filterTypeValue)) {
                        isVisible = false;
                    }
                }

                // 2. Check Search (Transaction ID or User ID)
                if (searchValue && !item.searchText.includes(searchValue)) {
                    isVisible = false;
                }

                // Toggle visibility
                item.element.style.display = isVisible ? '' : 'none';

                // Handle hidden details
                if (item.detailElement && item.detailElement.classList.contains('tx-detail-row')) {
                    item.detailElement.style.display = 'none';
                    const btn = item.element.querySelector('.btn-view-tx');
                    if (btn) btn.textContent = 'View';
                }
            });

            // SORTING
            const sortKey = sortBy.value;
            const order = sortOrder.value;

            rowData.sort((a, b) => {
                let valA, valB;

                if (sortKey === 'date') {
                    valA = new Date(a.dateStr);
                    valB = new Date(b.dateStr);
                } else if (sortKey === 'txid') {
                    valA = a.txid;
                    valB = b.txid;
                } else if (sortKey === 'userid') {
                    valA = a.userid;
                    valB = b.userid;
                } else if (sortKey === 'type') {
                    valA = a.type;
                    valB = b.type;
                }

                if (valA < valB) return order === 'asc' ? -1 : 1;
                if (valA > valB) return order === 'asc' ? 1 : -1;
                return 0;
            });

            // Re-append sorted rows
            rowData.forEach(item => {
                tableBody.appendChild(item.element);
                if (item.detailElement) {
                    tableBody.appendChild(item.detailElement);
                }
            });
        }

        if (typeFilter) typeFilter.addEventListener('change', updateTable);
        if (sortBy) sortBy.addEventListener('change', updateTable);
        if (sortOrder) sortOrder.addEventListener('change', updateTable);
        if (searchBox) searchBox.addEventListener('keyup', updateTable);

    })();
</script>