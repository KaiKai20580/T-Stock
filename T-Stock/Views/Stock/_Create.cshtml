@model T_Stock.Models.StockTransactionListVM

@{
    ViewData["Title"] = "Create Stock Transactions";
    bool isAjax = Context.Request.Headers["X-Requested-With"] == "XMLHttpRequest";
    Layout = isAjax ? null : "_Layout";
}

@if (!isAjax)
{
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
}

<style>
    /* ===== General Styles ===== */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: Arial, sans-serif;
    }

    body {
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* ===== TABLE CONTAINER STYLE ===== */
    .stock-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }

        .stock-table th, .stock-table td {
            width: 200px;
            padding: 10px;
            font-size: 1rem;
            border-bottom: 1px solid #ddd;
        }

        .stock-table th {
            background-color: lightgrey;
            font-weight: 900;
            font-size: 1.1rem;
            white-space: nowrap;
            text-align: center;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .stock-table td {
            background-color: white;
            font-weight: 500;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

            /* ===== ACTION COLUMN ===== */
            .stock-table th:last-child, .stock-table td:last-child {
                width: 200px;
                min-width: 200px;
                text-align: center;
                vertical-align: middle;
            }

    /* ===== Input & Select Styling ===== */
    .form-control {
        width: 100%;
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 1rem;
        background-color: white;
        transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
    }

    select.form-control {
        cursor: pointer;
    }

    /* ===== Button Styles ===== */
    .btn-common {
        text-decoration: none;
        padding: 8px 16px;
        border-radius: 15px;
        border: none;
        cursor: pointer;
        font-weight: 700;
        font-size: 1rem;
        transition: all 0.3s ease;
        display: inline-block;
    }

    /* Standardized Action Button Style */
    .btn-action {
        padding: 10px 20px;
        border-radius: 15px;
        border: none;
        cursor: pointer;
        font-weight: 700;
        font-size: 1rem;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 40px;
        min-width: 120px;
        text-decoration: none;
    }

    .btn-nav {
        background-color: #eee;
        color: black;
    }

        .btn-nav:hover {
            background-color: #ccc;
        }

    .btn-add-row {
        background-color: #87CEEB;
        color: black;
    }

        .btn-add-row:hover {
            background-color: #5FB6D9;
        }

    .btn-create {
        background-color: #90EE90;
        color: black;
    }

        .btn-create:hover {
            background-color: #76c976;
        }

    /* ===== REMOVE BUTTON ===== */
    .removeProductBtn {
        background: #ff4d4d !important;
        color: white !important;
        border: none;
        border-radius: 15px;
        padding: 8px 16px;
        cursor: pointer;
        font-weight: 700;
        font-size: 0.9rem;
        display: flex;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
    }

        .removeProductBtn:hover {
            background: #d90000 !important;
        }

    /* ===== Row Animations ===== */
    #item-rows tr {
        transition: transform 0.3s ease, opacity 0.3s ease;
        transform-origin: top;
    }

        #item-rows tr.adding {
            opacity: 0;
            transform: scaleY(0);
        }

            #item-rows tr.adding.show {
                opacity: 1;
                transform: scaleY(1);
            }

        #item-rows tr.removing {
            opacity: 0;
            transform: scaleY(0);
        }

    .down_container {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        gap: 15px;
        margin-top: 20px;
    }

    .navigation-buttons {
        margin-top: 15px;
        display: flex;
        gap: 15px;
    }

    .text-danger {
        color: red;
        font-size: 0.8rem;
    }

    .field-validation-error {
        color: red;
        font-size: 0.8rem;
        display: block;
        margin-top: 5px;
    }

    select.input-validation-error {
        border: 1px solid red;
    }

    /* ========================================= */
    /* DARK MODE OVERRIDES             */
    /* ========================================= */

    /* 1. Main Background and Text */
    body.dark-mode {
        background-color: black; /* Very dark grey/black */
        color: #e0e0e0; /* Light grey text */
    }

        /* 2. Headings */
        body.dark-mode h2 {
            color: #ffffff;
        }

        /* 3. Table Styling */
        body.dark-mode .stock-table th {
            background-color: #333333; /* Dark header background */
            color: #ffffff;
            border-bottom: 1px solid #444;
        }

        body.dark-mode .stock-table td {
            background-color: #1e1e1e; /* Dark row background */
            color: #e0e0e0;
            border-bottom: 1px solid #444;
        }

        /* 4. Form Controls (Inputs & Selects) */
        body.dark-mode .form-control {
            background-color: #2b2b2b;
            border: 1px solid #444;
            color: #ffffff;
        }

            body.dark-mode .form-control:focus {
                border-color: #87CEEB; /* Keep the light blue focus for visibility */
                background-color: #333;
            }

        /* 5. Navigation Buttons (Home / Back) */
        body.dark-mode .btn-nav {
            background-color: #333;
            color: #ffffff;
            border: 1px solid #444;
        }

            body.dark-mode .btn-nav:hover {
                background-color: #444;
            }

        /* 6. Validation Errors */
        /* Use a lighter red on dark backgrounds for readability */
        body.dark-mode .text-danger,
        body.dark-mode .field-validation-error {
            color: #ff6b6b;
        }

        body.dark-mode select.input-validation-error {
            border-color: #ff6b6b;
        }
</style>

<div class="CREATE">
    <h2>Add Stock Transactions</h2>

    <form id="createTransactionForm" asp-controller="Stock" asp-action="CreateTransaction" method="post">
        <table class="stock-table">
            <thead>
                <tr>
                    <th>Reason</th>
                    <th>Type</th>
                    <th>Quantity</th>
                    <th>Product Name</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="item-rows">
                @{
                    int count = Model?.Items?.Count ?? 0;
                }

                @if (count > 0)
                {
                    @for (int i = 0; i < count; i++)
                    {
                        var transaction = Model.Items[i];
                        var item = (Model.TransactionItems != null && Model.TransactionItems.Count > i) ? Model.TransactionItems[i] : new T_Stock.Models.StockTransactionItem();

                        <tr class="transaction-row show">
                            <td>
                                <input name="Items[@i].Reason" value="@transaction.Reason" class="form-control js-reason" @(i == 0 ? "required" : "") />
                                <span class="text-danger field-validation-valid"></span>
                            </td>
                            <td>
                                <select name="Items[@i].transactionType" class="form-control js-type">
                                    @if (i > 0)
                                    {
                                        <option value="">-- Select --</option>
                                    }
                                    <!option value="IN" @(transaction.transactionType == "IN" ? "selected" : "")>IN</!option>
                                    <!option value="OUT" @(transaction.transactionType == "OUT" ? "selected" : "")>OUT</!option>
                                </select>
                            </td>
                            <td>
                                <input name="TransactionItems[@i].QtyChange" value="@item.QtyChange" type="number" class="form-control js-qty" min="1" required />
                                <span class="text-danger field-validation-valid"></span>
                            </td>
                            <td>
                                <select name="TransactionItems[@i].ProductID" class="form-control product-select js-product">
                                    <option value="" disabled selected>-- Select Product --</option>
                                    @if (Model.Products != null)
                                    {
                                        foreach (var prod in Model.Products)
                                        {
                                            <!option value="@prod.ProductId" @(item.ProductID == prod.ProductId ? "selected" : "")>
                                            @prod.ProductName
                                            </!option>
                                        }
                                    }
                                </select>
                                <span class="text-danger error-span"></span>
                            </td>
                            <td>
                                @if (i > 0)
                                {
                                    <button type="button" class="removeProductBtn">Remove</button>
                                }
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr class="transaction-row show">
                        <td>
                            <input name="Items[0].Reason" class="form-control js-reason" required />
                            <span class="text-danger field-validation-valid"></span>
                        </td>
                        <td>
                            <select name="Items[0].transactionType" class="form-control js-type">
                                <option value="IN">IN</option>
                                <option value="OUT">OUT</option>
                            </select>
                        </td>
                        <td>
                            <input name="TransactionItems[0].QtyChange" type="number" class="form-control js-qty" value="0" min="1" required />
                            <span class="text-danger field-validation-valid"></span>
                        </td>
                        <td>
                            <select name="TransactionItems[0].ProductID" class="form-control product-select js-product">
                                <option value="" disabled selected>-- Select Product --</option>
                                @if (Model != null && Model.Products != null)
                                {
                                    @foreach (var prod in Model.Products)
                                    {
                                        <option value="@prod.ProductId">@prod.ProductName</option>
                                    }
                                }
                            </select>
                            <span class="text-danger error-span"></span>
                        </td>
                        <td></td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="down_container">
            <button type="button" class="btn-action btn-add-row">
                <i class="ri-add-line" style="margin-right: 5px;"></i> Add Row
            </button>

            <button type="button" id="btnSubmit" class="btn-action btn-create ajax-nav" data-ajax="page">
                Create
            </button>
        </div>
    </form>

    <div class="navigation-buttons">
        <a href="/Home/Index" class="btn-common btn-nav ajax-nav" data-ajax="page">Home</a>
        <a href="/Stock/Index" class="btn-common btn-nav ajax-nav" data-ajax="page">Back</a>
    </div>
</div>

<script>
    (function() {
        // Serialize the product list for the "Add Row" function
        var availableProducts = @Html.Raw(Json.Serialize(Model?.Products ?? new List<T_Stock.Models.Product>()));

        function showError(input, span, message) {
            input.addClass("input-validation-error");
            span.text(message);
            span.removeClass("field-validation-valid").addClass("field-validation-error");
        }

        function clearError(input, span) {
            input.removeClass("input-validation-error");
            span.text("");
            span.removeClass("field-validation-error").addClass("field-validation-valid");
        }

        // Re-indexes names so the ModelBinder works (Items[0], Items[1], etc.)
        function updateIndices() {
            $('#item-rows tr').each(function (index) {
                $(this).find(':input').each(function () {
                    var name = $(this).attr('name');
                    if (name) {
                        // Regex to replace the index number
                        var newName = name.replace(/\[\d+\]/, '[' + index + ']');
                        $(this).attr('name', newName);
                    }
                });
            });
        }

        // --- 1. Add Row Logic ---
        $(document).off('click', '.btn-add-row').on('click', '.btn-add-row', function () {
            var tableBody = $("#item-rows");
            var rowIndex = tableBody.find("tr").length;

            // Generate Product Options
            let optionsHtml = '<option value="" disabled selected>-- Select Product --</option>';
            if(availableProducts){
                availableProducts.forEach(prod => {
                    optionsHtml += `<option value="${prod.productId}">${prod.productName}</option>`;
                });
            }

            // HTML for the new row
            // Note: We include classes js-reason, js-type, js-qty, js-product for the logic to work
            var newRowHtml = `
                <tr class="transaction-row adding">
                    <td>
                    </td>
                    <td>
                    </td>
                    <td>
                        <input name="TransactionItems[${rowIndex}].QtyChange" type="number" class="form-control js-qty" value="1" min="1" required />
                        <span class="text-danger field-validation-valid"></span>
                    </td>
                    <td>
                        <select name="TransactionItems[${rowIndex}].ProductID" class="form-control product-select js-product">
                            ${optionsHtml}
                        </select>
                        <span class="text-danger error-span"></span>
                    </td>
                    <td>
                        <button type="button" class="removeProductBtn">Remove</button>
                    </td>
                </tr>`;

            var $newRow = $(newRowHtml);
            tableBody.append($newRow);

            // Animation
            requestAnimationFrame(() => {
                $newRow.addClass("show");
            });
        });

        // --- 2. Remove Logic ---
        $(document).off('click', '.removeProductBtn').on('click', '.removeProductBtn', function () {
            var row = $(this).closest('tr');
            row.addClass('removing');
            setTimeout(() => {
                row.remove();
                updateIndices();
            }, 30);
        });

        // --- 3. MERGE LOGIC (Crucial Step) ---
        $(document).off('change', '.js-product').on('change', '.js-product', function () {
            var $currentSelect = $(this);
            var $currentRow = $currentSelect.closest('tr');
            var selectedProductId = $currentSelect.val();

            // We must match Type (IN/OUT) as well as Product
            var currentType = $currentRow.find('.js-type').val();
            var currentQty = parseFloat($currentRow.find('.js-qty').val()) || 0;

            if (!selectedProductId) return;

            // Iterate over all OTHER rows
            $('.transaction-row').not($currentRow).each(function () {
                var $otherRow = $(this);
                var otherProductId = $otherRow.find('.js-product').val();
                var otherType = $otherRow.find('.js-type').val();

                // Check for duplicate: Same Product AND Same Transaction Type (IN/IN or OUT/OUT)
                if (otherProductId === selectedProductId && otherType === currentType) {

                    var otherQtyInput = $otherRow.find('.js-qty');
                    var otherQty = parseFloat(otherQtyInput.val()) || 0;

                    // A. Update Existing Row
                    var newTotal = otherQty + currentQty;
                    otherQtyInput.val(newTotal);

                    // B. Reset Current Row (to prevent duplicate entry)
                    $currentSelect.val(""); // Reset dropdown
                    $currentRow.find('.js-qty').val(1); // Reset qty default

                    // C. Visual Feedback
                    alert("Merged: Product '" + $currentSelect.find("option:selected").text() + "' already exists. Quantity added to existing row.");

                    // Flash effect
                    $otherRow.css("transition", "background-color 0.5s");
                    $otherRow.css("background-color", "#90EE90"); // Light Green
                    setTimeout(function() {
                        $otherRow.css("background-color", "");
                    }, 1000);

                    return false; // Stop loop
                }
            });
        });

        // --- 4. Submit Validation ---
        $("#btnSubmit").off("click").on("click", function (e) {
            e.preventDefault();
            var $form = $("#createTransactionForm");
            let isValid = true;

            $("#item-rows tr").each(function (index) {
                var row = $(this);
                var reasonInput = row.find(".js-reason");
                var quantityInput = row.find(".js-qty");
                var productSelect = row.find(".js-product");

                var reasonSpan = reasonInput.next("span");
                var quantitySpan = quantityInput.next("span");
                var productSpan = productSelect.next("span");

                // Validate Reason (Strict only for first row)
                if (index === 0 && (!reasonInput.val() || reasonInput.val().trim() === "")) {
                    isValid = false;
                    showError(reasonInput, reasonSpan, "Reason is required");
                } else {
                    clearError(reasonInput, reasonSpan);
                }

                // Validate Quantity
                var qtyVal = parseFloat(quantityInput.val());
                if (isNaN(qtyVal) || qtyVal <= 0) {
                    isValid = false;
                    showError(quantityInput, quantitySpan, "Qty > 0");
                } else {
                    clearError(quantityInput, quantitySpan);
                }

                // Validate Product
                if (!productSelect.val() || productSelect.val() === "") {
                    isValid = false;
                    showError(productSelect, productSpan, "Product required");
                } else {
                    clearError(productSelect, productSpan);
                }
            });

            if (!isValid) return;

            updateIndices(); // Ensure indices are correct [0], [1], [2] before submit

            $.ajax({
                url: "/Stock/CreateTransaction",
                type: "POST",
                data: $form.serialize(),
                success: function (result) {
                    if (result.success) {
                        window.location.href = "/Stock/Index";
                    } else {
                        $(".CREATE").parent().html(result);
                    }
                },
                error: function (xhr) {
                    alert("Server error.");
                }
            });
        });
    })();
</script>