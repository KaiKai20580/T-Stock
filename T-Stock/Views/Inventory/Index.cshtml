@model T_Stock.Models.InventoryTableViewModel
<title>@ViewData["Title"]</title>
@{
    ViewData["Title"] = "Inventory";
}

@* 1. NOTIFICATION CONTAINER 
   This renders only if the Controller passed a success message (e.g., after Edit or Delete).
*@
@if (TempData["SuccessMessage"] != null)
{
    <div id="slide-notification">
        <i class="ri-checkbox-circle-fill"></i> @TempData["SuccessMessage"]
    </div>
}

<div class="INVENTORY">
    <h3>Inventory</h3>

    @Html.AntiForgeryToken()

    <div class="inven-search-container">
        <input type="text" id="searchBox" placeholder="Search by Product Name..." />
        <i class="ri-search-line"></i>
    </div>

    <div class="inventory-toolbar">
        <div class="sort-group">
            <label>Sort by</label>
            <select id="sortBy">
                <option value="ProductId">Product ID</option>
                <option value="ProductName">Product Name</option>
                <option value="Category">Category</option>
                <option value="Quantity">Quantity</option>
                <option value="ReorderLevel">Reorder Level</option>
                <option value="Price">Price</option>
            </select>

            <button id="sortDirBtn" class="sort-dir" data-dir="asc" title="Toggle sort direction">
                <i class="ri-arrow-up-line"></i>
            </button>
        </div>
    </div>

    <div id="inventory-table">
        <table class="inven-table">
            <thead>
                <tr>
                    <th>Product ID</th>
                    <th>Product Name</th>
                    <th>Category</th>
                    <th>Quantity</th>
                    <th>Reorder Level</th>
                    <th>Price</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                @* Initial Server-Side Render *@
                @foreach (var item in Model.Products)
                {
                    var highlightClass = ViewBag.HighlightProductId == item.ProductId ? "highlight" : "";

                    <tr id="product-@item.ProductId" class="@highlightClass inventory-row">
                        <td>@item.ProductId</td>
                        <td>@item.ProductName</td>
                        <td>@item.Category</td>
                        <td>@item.Quantity</td>
                        <td>@item.ReorderLevel</td>
                        <td>@item.Price</td>
                        <td>
                            <a href="/Inventory/Edit/@item.ProductId" class="action-btn edit-btn">Edit</a>

                            <form asp-action="Delete" asp-controller="Inventory" method="post" onsubmit="return confirm('Are you sure you want to delete this product?');" style="display:inline;">
                                <input type="hidden" name="productId" value="@item.ProductId" />
                                <button type="submit" class="action-btn delete-btn">Delete</button>
                            </form>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <div id="pagination-container">
            @if (Model.TotalPages > 0)
            {
                <div class="pagination">
                    @for (int i = 1; i <= Model.TotalPages; i++)
                    {
                        <button type="button"
                                class="page-btn @(i == Model.CurrentPage ? "active" : "")"
                                data-page="@i">
                            @i
                        </button>
                    }
                </div>
            }
        </div>

        <a class="ajax-nav btn btn-secondary" data-ajax="page" href="/Inventory/Create">
            Create
        </a>

    </div>
</div>

<style>
    /* --- 2. SLIDE-IN NOTIFICATION CSS --- */
    #slide-notification {
        position: fixed;
        top: -100px; /* Start hidden above the screen */
        left: 50%;
        transform: translateX(-50%);
        /* Green Success Color */
        background-color: #28a745;
        color: white;
        padding: 15px 30px;
        border-radius: 0 0 10px 10px; /* Rounded bottom corners */
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 9999;
        font-weight: 600;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 10px;
        /* Smooth Bouncy Transition */
        transition: top 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }

        /* Class added by JS to slide it down */
        #slide-notification.show {
            top: 0;
        }

    /* --- Existing Styles --- */
    .action-btn {
        padding: 6px 12px;
        font-size: 14px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        display: inline-block;
        text-decoration: none;
        line-height: normal;
        vertical-align: middle;
    }

    .delete-btn {
        background-color: #ff4d4f;
        color: white;
        margin-left: 5px;
    }

        .delete-btn:hover {
            background-color: #d9363e;
        }

    .edit-btn {
        background-color: #ffc107;
        color: #212529;
    }

        .edit-btn:hover {
            background-color: #e0a800;
            color: #212529;
        }

    .sort-dir i {
        display: inline-block;
    }
</style>

<script>
    (function() {
        // --- CONFIGURATION ---
        const STORAGE_KEY = 'InventoryPage_State';

        function initInventoryPage() {
            console.log("Initializing Inventory Page Logic...");

            // --- 3. NOTIFICATION LOGIC (Updated) ---
            var notification = document.getElementById("slide-notification");
            if (notification) {
                // Slide down (add 'show' class)
                setTimeout(function () {
                    notification.classList.add("show");
                }, 100);

                // Slide up (remove 'show' class) after 3 seconds
                setTimeout(function () {
                    notification.classList.remove("show");
                }, 3000);
            }
            // -------------------------------------

            const searchBox = document.getElementById('searchBox');
            const sortBy = document.getElementById('sortBy');
            const sortDirBtn = document.getElementById('sortDirBtn');
            const paginationContainer = document.getElementById('pagination-container');
            const csrfTokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
            const csrfToken = csrfTokenInput ? csrfTokenInput.value : '';

            // --- ID DETECTION ---
            let highlightId = '@ViewBag.HighlightProductId';
            if ((!highlightId || highlightId === '') && window.location.hash.startsWith('#product-')) {
                highlightId = window.location.hash.substring(9);
            }

            // --- LOAD DATA ---
            try {
                window.inventoryData = @Html.Raw(Json.Serialize(Model.AllProducts)) || [];
            } catch (e) {
                console.error("Inventory Data Load Failed:", e);
                window.inventoryData = [];
            }

            // --- CONFIG SETUP ---
            const defaultPageSize = parseInt('@Model.PageSize') || 10;
            let initialState = {
                currentPage: 1,
                pageSize: defaultPageSize,
                currentSortKey: sortBy ? sortBy.value : 'ProductId',
                currentSortDir: 'asc',
                searchTerm: ''
            };

            const savedStateJSON = sessionStorage.getItem(STORAGE_KEY);
            if (savedStateJSON) {
                try {
                    const savedState = JSON.parse(savedStateJSON);
                    initialState = { ...initialState, ...savedState };
                    initialState.pageSize = parseInt(initialState.pageSize);
                } catch (err) { console.error(err); }
            }

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('page')) {
                const urlPage = parseInt(urlParams.get('page'));
                if (!isNaN(urlPage)) initialState.currentPage = urlPage;
            }
            if (urlParams.has('search')) initialState.searchTerm = urlParams.get('search');
            if (urlParams.has('sort')) initialState.currentSortKey = urlParams.get('sort');
            if (urlParams.has('dir')) initialState.currentSortDir = urlParams.get('dir');

            if (initialState.searchTerm && initialState.searchTerm.trim() !== "") {
                initialState.currentPage = 1;
            }

            window.pageConfig = initialState;

            // --- SYNC UI ---
            if (searchBox) searchBox.value = window.pageConfig.searchTerm;
            if (sortBy) sortBy.value = window.pageConfig.currentSortKey;
            if (sortDirBtn) {
                sortDirBtn.setAttribute('data-dir', window.pageConfig.currentSortDir);
                const icon = sortDirBtn.querySelector('i');
                if(icon) icon.className = window.pageConfig.currentSortDir === 'asc' ? 'ri-arrow-up-line' : 'ri-arrow-down-line';
            }

            // --- HELPERS ---
            function getSafeValue(obj, key) {
                if (!obj) return "";
                let val = undefined;
                if (obj.hasOwnProperty(key)) val = obj[key];
                else {
                    const camelKey = key.charAt(0).toLowerCase() + key.slice(1);
                    if (obj.hasOwnProperty(camelKey)) val = obj[camelKey];
                }
                return (val === null || val === undefined) ? "" : val;
            }

            function updateSortIcon(btn, dir) {
                const icon = btn.querySelector('i');
                if(icon) icon.className = dir === 'asc' ? 'ri-arrow-up-line' : 'ri-arrow-down-line';
            }

            function updatePaginationButtons() {
                const container = document.getElementById('pagination-container');
                if (!container) return;
                const buttons = container.querySelectorAll('.page-btn');
                const current = window.pageConfig.currentPage;
                buttons.forEach(btn => {
                    const pageNum = parseInt(btn.getAttribute('data-page'));
                    if (pageNum === current) btn.classList.add('active');
                    else btn.classList.remove('active');
                });
            }

            function processData(data, config) {
                let processed = [...data];
                const searchValue = (config.searchTerm || "").toLowerCase().trim();
                const sortKey = config.currentSortKey;
                const order = config.currentSortDir;

                if (searchValue) {
                    processed = processed.filter(item => {
                        const name = String(getSafeValue(item, 'ProductName')).toLowerCase();
                        return name.startsWith(searchValue);
                    });
                }

                processed.sort((a, b) => {
                    let valA = getSafeValue(a, sortKey);
                    let valB = getSafeValue(b, sortKey);
                    const numA = parseFloat(valA);
                    const numB = parseFloat(valB);
                    const isNum = !isNaN(numA) && !isNaN(numB) && valA !== "" && valB !== "";

                    if (isNum) return order === 'asc' ? numA - numB : numB - numA;
                    else {
                        valA = String(valA).toLowerCase();
                        valB = String(valB).toLowerCase();
                        if (valA < valB) return order === 'asc' ? -1 : 1;
                        if (valA > valB) return order === 'asc' ? 1 : -1;
                        return 0;
                    }
                });
                return processed;
            }

                function renderTable(data) {
                    const tableBody = document.querySelector('.inven-table tbody');
                    if (!tableBody) return;
                    tableBody.innerHTML = '';

                    if (!data || data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px;">No products found</td></tr>';
                        return;
                    }

                    const fragment = document.createDocumentFragment();
                    let highlightedRow = null;

                    data.forEach(item => {
                        const tr = document.createElement('tr');
                        const pId = getSafeValue(item, 'ProductId');
                        // Check if this is the row to highlight
                        const isHighlight = highlightId && (String(pId) === String(highlightId));

                        if (isHighlight) {
                            // We do NOT add the class here yet. We just capture the row element.
                            highlightedRow = tr;
                            highlightId = null; // Reset global var so it doesn't trigger again
                        }

                        tr.classList.add('inventory-row');
                        tr.id = `product-${pId}`;

                        tr.innerHTML = `
                            <td>${pId}</td>
                            <td>${getSafeValue(item, 'ProductName')}</td>
                            <td>${getSafeValue(item, 'Category')}</td>
                            <td>${getSafeValue(item, 'Quantity')}</td>
                            <td>${getSafeValue(item, 'ReorderLevel')}</td>
                            <td>${getSafeValue(item, 'Price')}</td>
                            <td>
                                <a href="/Inventory/Edit/${pId}" class="action-btn edit-btn">Edit</a>
                                <form action="/Inventory/Delete" method="post" onsubmit="return confirm('Are you sure you want to delete this product?');" style="display:inline;">
                                    <input type="hidden" name="__RequestVerificationToken" value="${csrfToken}" />
                                    <input type="hidden" name="productId" value="${pId}" />
                                    <button type="submit" class="action-btn delete-btn">Delete</button>
                                </form>
                            </td>
                        `;
                        fragment.appendChild(tr);
                    });
                    tableBody.appendChild(fragment);

                    // --- HIGHLIGHT ANIMATION LOGIC ---
                    if (highlightedRow) {
                        // 1. Scroll immediately so user sees the target area
                        highlightedRow.scrollIntoView({ behavior: 'smooth', block: 'center' });

                        // 2. Wait 1000ms (Start Highlight Delay)
                        setTimeout(() => {
                            highlightedRow.classList.add('highlight');

                            // 3. Wait 1000ms (Duration of Highlight), then remove
                            setTimeout(() => {
                                highlightedRow.classList.remove('highlight');
                            }, 1000);

                        }, 1000);
                    }
                }

            function updateTable() {
                if (!window.inventoryData) return;

                sessionStorage.setItem(STORAGE_KEY, JSON.stringify(window.pageConfig));
                const newUrl = new URL(window.location);
                newUrl.searchParams.set('page', window.pageConfig.currentPage);
                if(window.pageConfig.searchTerm) newUrl.searchParams.set('search', window.pageConfig.searchTerm);
                else newUrl.searchParams.delete('search');
                newUrl.searchParams.set('sort', window.pageConfig.currentSortKey);
                newUrl.searchParams.set('dir', window.pageConfig.currentSortDir);
                window.history.replaceState(null, '', newUrl);

                let processedData = processData(window.inventoryData, window.pageConfig);
                const container = document.getElementById('pagination-container');
                const hasSearch = (window.pageConfig.searchTerm || "").trim() !== "";

                if (!hasSearch) {
                    if(container) container.style.display = 'block';
                    const startIndex = (window.pageConfig.currentPage - 1) * window.pageConfig.pageSize;
                    const endIndex = startIndex + window.pageConfig.pageSize;
                    processedData = processedData.slice(Math.max(0, startIndex), endIndex);
                    updatePaginationButtons();
                } else {
                    if(container) container.style.display = 'none';
                }

                renderTable(processedData);
            }

            // --- EVENT LISTENERS ---
            if (searchBox) {
                const newSearch = searchBox.cloneNode(true);
                searchBox.parentNode.replaceChild(newSearch, searchBox);
                newSearch.addEventListener('keyup', function(e) {
                    window.pageConfig.searchTerm = e.target.value;
                    window.pageConfig.currentPage = 1;
                    updateTable();
                });
                newSearch.value = window.pageConfig.searchTerm;
                if(document.activeElement === searchBox) newSearch.focus();
            }
            if (sortBy) {
                const newSort = sortBy.cloneNode(true);
                sortBy.parentNode.replaceChild(newSort, sortBy);
                newSort.addEventListener('change', function() {
                    window.pageConfig.currentSortKey = this.value;
                    updateTable();
                });
                newSort.value = window.pageConfig.currentSortKey;
            }
            if (sortDirBtn) {
                const newBtn = sortDirBtn.cloneNode(true);
                sortDirBtn.parentNode.replaceChild(newBtn, sortDirBtn);
                updateSortIcon(newBtn, window.pageConfig.currentSortDir);
                newBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const newDir = window.pageConfig.currentSortDir === 'asc' ? 'desc' : 'asc';
                    window.pageConfig.currentSortDir = newDir;
                    this.setAttribute('data-dir', newDir);
                    updateSortIcon(this, newDir);
                    updateTable();
                });
            }
            if (paginationContainer) {
                const newPag = paginationContainer.cloneNode(true);
                paginationContainer.parentNode.replaceChild(newPag, paginationContainer);
                newPag.addEventListener('click', function(e) {
                    const btn = e.target.closest('.page-btn');
                    if (btn) {
                        e.preventDefault(); e.stopPropagation();
                        const newPage = parseInt(btn.getAttribute('data-page'));
                        if (!isNaN(newPage)) {
                            window.pageConfig.currentPage = newPage;
                            updateTable();
                        }
                    }
                });
            }

            if (highlightId && window.inventoryData.length > 0) {
                const tempSortedData = processData(window.inventoryData, window.pageConfig);
                const foundIndex = tempSortedData.findIndex(item =>
                    String(getSafeValue(item, 'ProductId')) === String(highlightId)
                );

                if (foundIndex !== -1) {
                    const size = parseInt(window.pageConfig.pageSize) || 10;
                    const correctPage = Math.floor(foundIndex / size) + 1;
                    if (window.pageConfig.currentPage !== correctPage) {
                        window.pageConfig.currentPage = correctPage;
                    }
                }
            }

            updateTable();
        }

        if (document.readyState === "complete" || document.readyState === "interactive") {
            initInventoryPage();
        } else {
            document.addEventListener("DOMContentLoaded", initInventoryPage);
        }

        window.onpageshow = function(event) {
            if (event.persisted) initInventoryPage();
        };
    })();
</script>