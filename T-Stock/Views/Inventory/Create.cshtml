@{
    ViewData["Title"] = "Create Product";
}
<title>@ViewData["Title"]</title>
@model T_Stock.Models.ProductListVM

<div class="CREATE-INVENTORY">
    <h2>Create Product</h2>
    <form asp-controller="Inventory" asp-action="Create" method="post" id="createProductForm">
        <table class="table">
            <thead>
                <tr>
                    <th>Product Name</th>
                    <th>Category</th>
                    <th>Quantity</th>
                    <th>Reorder Level</th>
                    <th>Price</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="item-rows">
                @for (int i = 0; i < Model.Items.Count; i++)
                {
                    <tr>
                        <td>
                            <input asp-for="Items[@i].ProductName" class="form-control" value="" />
                            <span asp-validation-for="Items[@i].ProductName" class="text-danger"></span>
                        </td>

                        <td>
                            <select asp-for="Items[@i].Category" class="form-control">
                                <option value="" disabled selected>-- Select --</option>
                                <option value="Food">Food</option>
                                <option value="Drink">Drink</option>
                                <option value="Snack">Snack</option>
                            </select>
                            <span asp-validation-for="Items[@i].Category" class="text-danger"></span>
                        </td>

                        <td>
                            <input asp-for="Items[@i].Quantity" type="number" class="form-control" />
                            <span asp-validation-for="Items[@i].Quantity" class="text-danger"></span>
                        </td>

                        <td>
                            <input asp-for="Items[@i].ReorderLevel" type="number" class="form-control" />
                            <span asp-validation-for="Items[@i].ReorderLevel" class="text-danger"></span>
                        </td>

                        <td>
                            <input asp-for="Items[@i].Price" type="number" class="form-control" step="0.01"/>
                            <span asp-validation-for="Items[@i].Price" class="text-danger"></span>
                        </td>

                        <td>
                            @if (i > 0)
                            {
                                <button type="button" onclick="Inventory_RemoveRow(this)" class="btn-inv-custom btn-inv-remove">Remove</button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <button type="button" onclick="Inventory_AddRow()" class="button btn-inv-custom btn-inv-add">
            + Add Row
        </button>

        <button type="submit" class="ajax-button button btn-inv-custom btn-inv-create" data-url="/Inventory/Index">
            Create
        </button>

    </form>

    <br />
    <a href="/Home/Index" class="btn btn-secondary ajax-nav" data-ajax="page">Home</a>
    <a href="/Inventory/Index" class="btn btn-secondary ajax-nav" data-ajax="page">Back</a>
</div>

@* HIDDEN TEMPLATE 
   We use a dummy index like [-1] or [0] which we will replace via Javascript later.
*@
<template id="row-template">
    <tr>
        <td>
            <input name="Items[0].ProductName" class="form-control" type="text" value="" />
            <span class="text-danger field-validation-valid" data-valmsg-for="Items[0].ProductName" data-valmsg-replace="true"></span>
        </td>
        <td>
            <select name="Items[0].Category" class="form-control">
                <option value="" disabled selected>-- Select --</option>
                <option value="Food">Food</option>
                <option value="Drink">Drink</option>
                <option value="Snack">Snack</option>
            </select>
            <span class="text-danger field-validation-valid" data-valmsg-for="Items[0].Category" data-valmsg-replace="true"></span>
        </td>
        <td>
            <input name="Items[0].Quantity" class="form-control" type="number" value="0" />
            <span class="text-danger field-validation-valid" data-valmsg-for="Items[0].Quantity" data-valmsg-replace="true"></span>
        </td>
        <td>
            <input name="Items[0].ReorderLevel" class="form-control" type="number" value="0" />
            <span class="text-danger field-validation-valid" data-valmsg-for="Items[0].ReorderLevel" data-valmsg-replace="true"></span>
        </td>
        <td>
            <input name="Items[0].Price" class="form-control" type="number" value="0" step="0.01"/>
            <span class="text-danger field-validation-valid" data-valmsg-for="Items[0].Price" data-valmsg-replace="true"></span>
        </td>
        <td>
            <button type="button" onclick="Inventory_RemoveRow(this)" class="btn-inv-custom btn-inv-remove">Remove</button>
        </td>
    </tr>
</template>

<style>
    .btn-inv-custom {
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

        .btn-inv-custom:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
        }

    /* GRAY BUTTON (Add Row) */
    .btn-inv-add {
        background-color: lightgray;
        color: #333;
        padding: 8px 16px;
        margin-right: 5px;
        font-weight: 500;
    }

        .btn-inv-add:hover {
            background-color: #bfbfbf;
        }

    /* GREEN BUTTON (Create) */
    .btn-inv-create {
        background-color: #28a745;
        color: white;
        padding: 8px 16px;
        font-weight: 500;
    }

        .btn-inv-create:hover {
            background-color: #218838;
        }

    /* RED BUTTON (Remove) */
    .btn-inv-remove {
        background-color: #dc3545;
        color: white;
        padding: 8px 16px;
        font-weight: 500;
    }

        .btn-inv-remove:hover {
            background-color: #c82333;
        }
</style>

<script>
    // Distinct name to avoid conflict with external 'addRow'
    function Inventory_AddRow() {
        var tbody = document.getElementById('item-rows');
        var template = document.getElementById('row-template');

        // 1. Clone the content of the template
        var clone = template.content.cloneNode(true);

        // 2. Append the new row to the table
        tbody.appendChild(clone);

        // 3. Update indices using the new function name
        Inventory_UpdateIndices();

        // 4. Re-initialize validation
        Inventory_RebindValidation();
    }

    // Distinct name to avoid conflict with external 'removeRow'
    function Inventory_RemoveRow(btn) {
        var row = btn.closest('tr');
        row.remove();

        // Update indices to ensure ASP.NET binding stays correct (0, 1, 2...)
        Inventory_UpdateIndices();
    }

    // Renamed helper function
    function Inventory_UpdateIndices() {
        var rows = document.querySelectorAll('#item-rows tr');

        rows.forEach((row, index) => {
            // Update Inputs and Selects
            var inputs = row.querySelectorAll('input, select');
            inputs.forEach(input => {
                // Replace Name: Items[anything].Prop -> Items[index].Prop
                if (input.name) {
                    input.name = input.name.replace(/Items\[\d+\]/, `Items[${index}]`);
                }
                // Replace ID
                if (input.id) {
                    input.id = input.id.replace(/Items_\d+__/, `Items_${index}__`);
                }
            });

            // Update Validation Spans
            var spans = row.querySelectorAll('span[data-valmsg-for]');
            spans.forEach(span => {
                var valFor = span.getAttribute('data-valmsg-for');
                if (valFor) {
                    span.setAttribute('data-valmsg-for', valFor.replace(/Items\[\d+\]/, `Items[${index}]`));
                }
            });
        });
    }

    // Renamed validation helper
    function Inventory_RebindValidation() {
        var form = $("#createProductForm");
        // Remove existing validation data
        form.removeData("validator");
        form.removeData("unobtrusiveValidation");
        // Re-parse the form to pick up new inputs
        $.validator.unobtrusive.parse(form);
    }
</script>